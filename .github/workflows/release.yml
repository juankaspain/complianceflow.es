name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '20'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          npm run lint
          npm run type-check
          npm run test:unit
          npm run build

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: ".github/changelog-config.json"
          toTag: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        run: |
          echo "## ${{ github.ref_name }} ($(date +%Y-%m-%d))" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo '${{ steps.changelog.outputs.changelog }}' >> RELEASE_NOTES.md
          cat CHANGELOG.md >> RELEASE_NOTES.md
          mv RELEASE_NOTES.md CHANGELOG.md

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Nothing to push"

  deploy-release:
    name: Deploy Release
    needs: create-release
    uses: ./.github/workflows/deploy-production.yml
    secrets: inherit
    with:
      environment: production

  notify-release:
    name: Notify Release
    needs: [create-release, deploy-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify success
        if: needs.deploy-release.result == 'success'
        run: |
          echo "✅ Release ${{ github.ref_name }} deployed successfully!"
          echo "Release notes: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

      - name: Notify failure
        if: needs.deploy-release.result != 'success'
        run: |
          echo "❌ Release ${{ github.ref_name }} deployment failed!"
          exit 1
